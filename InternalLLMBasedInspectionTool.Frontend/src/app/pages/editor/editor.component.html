<div class="editor-page">
    <app-header></app-header>
    <div class="editor-main">
        <div class="editor-layout">
            <app-attachments-panel
                [attachments]="attachments()"
                [currentAttachmentId]="currentAttachmentId()"
                (onAttachmentSelected)="onAttachmentSelected($event)"
                (onAttachmentsChanged)="onAttachmentsChanged()"
            ></app-attachments-panel>
            <div class="editor-content-wrapper">
            <app-code-editor
                (attachmentCreated)="onAttachmentCreated()"
                (analysisCompleted)="onAnalysisCompleted($event)"
            ></app-code-editor>
                <div class="editor-content">
                    <!-- Additional content will be added here -->
                </div>
            </div>
        </div>
    </div>
    <footer class="editor-footer">
        <button class="footer-tab" (click)="onIssuesClick()">
            <span class="tab-label">Issues</span>
        </button>
        <button class="footer-tab" (click)="onPromptSettingsClick()">
            <span class="tab-label">Prompt Settings</span>
        </button>
    </footer>

    <app-toast></app-toast>

    @if (showIssuesModal() && analysisResult()) {
        <app-issues-display
            [analysis]="analysisResult()!"
            [attachmentId]="currentAttachmentId() || ''"
            [currentEditedData]="currentEditedData()"
            [codeLanguage]="codeEditor()?.getCodeLanguage() || 'typescript'"
            [isOpen]="showIssuesModal()"
            [onClose]="closeIssuesModal.bind(this)"
            (onFixCodeResult)="onFixCodeResult($event)"
            (onIssuesFixed)="onIssuesFixed($event)"
        ></app-issues-display>
    }

    @if (showFixDiffModal() && currentEditedData() && fixedCode()) {
        <app-diff-modal
            [originalContent]="currentEditedData()"
            [editedContent]="fixedCode()"
            [language]="codeEditor()?.getCodeLanguage() || 'typescript'"
            [isOpen]="showFixDiffModal()"
            [onClose]="closeFixDiffModal.bind(this)"
            (onAcceptChanges)="onAcceptFixedChanges($event)"
        ></app-diff-modal>
    }

    @if (showPromptSettingsModal()) {
        <div class="modal-backdrop" (click)="closePromptSettingsModal()">
            <div
                class="modal-content prompt-settings-modal"
                (click)="$event.stopPropagation()"
            >
                <div class="modal-header">
                    <h2 class="modal-title">Prompt Settings</h2>
                    <button
                        aria-label="Close"
                        class="close-button"
                        [innerHTML]="closeIcon"
                        (click)="closePromptSettingsModal()"
                    ></button>
                </div>
                <div class="modal-body">
                    @if (promptSettings()) {
                        <div class="prompt-settings-form">
                            <div class="settings-grid">
                                <div class="settings-group">
                                    <h3 class="settings-group-title">
                                        Code Quality Checks
                                    </h3>
                                    <div class="settings-row">
                                        <label class="checkbox-label">
                                            <input
                                                type="checkbox"
                                                [(ngModel)]="
                                                    promptSettings()!
                                                        .checkReadability
                                                "
                                            />
                                            <span>Check Readability</span>
                                        </label>
                                    </div>
                                    <div class="settings-row">
                                        <label class="checkbox-label">
                                            <input
                                                type="checkbox"
                                                [(ngModel)]="
                                                    promptSettings()!
                                                        .checkPerformance
                                                "
                                            />
                                            <span>Check Performance</span>
                                        </label>
                                    </div>
                                    <div class="settings-row">
                                        <label class="checkbox-label">
                                            <input
                                                type="checkbox"
                                                [(ngModel)]="
                                                    promptSettings()!
                                                        .checkCorrectness
                                                "
                                            />
                                            <span>Check Correctness</span>
                                        </label>
                                    </div>
                                    <div class="settings-row">
                                        <label class="checkbox-label">
                                            <input
                                                type="checkbox"
                                                [(ngModel)]="
                                                    promptSettings()!.checkStyle
                                                "
                                            />
                                            <span>Check Style</span>
                                        </label>
                                    </div>
                                    <div class="settings-row">
                                        <label class="checkbox-label">
                                            <input
                                                type="checkbox"
                                                [(ngModel)]="
                                                    promptSettings()!
                                                        .checkMaintainability
                                                "
                                            />
                                            <span>Check Maintainability</span>
                                        </label>
                                    </div>
                                    <div class="settings-row">
                                        <label class="checkbox-label">
                                            <input
                                                type="checkbox"
                                                [(ngModel)]="
                                                    promptSettings()!
                                                        .checkSecurity
                                                "
                                            />
                                            <span>Check Security</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="settings-group">
                                    <h3 class="settings-group-title">
                                        Detection Options
                                    </h3>
                                    <div class="settings-row">
                                        <label class="checkbox-label">
                                            <input
                                                type="checkbox"
                                                [(ngModel)]="
                                                    promptSettings()!
                                                        .detectLargeExpressions
                                                "
                                            />
                                            <span
                                                >Detect Large Expressions</span
                                            >
                                        </label>
                                    </div>
                                    <div class="settings-row">
                                        <label class="checkbox-label">
                                            <input
                                                type="checkbox"
                                                [(ngModel)]="
                                                    promptSettings()!
                                                        .detectNestedConditions
                                                "
                                            />
                                            <span
                                                >Detect Nested Conditions</span
                                            >
                                        </label>
                                    </div>
                                    <div class="settings-row">
                                        <label class="checkbox-label">
                                            <input
                                                type="checkbox"
                                                [(ngModel)]="
                                                    promptSettings()!
                                                        .evaluateMemoryAllocations
                                                "
                                            />
                                            <span
                                                >Evaluate Memory
                                                Allocations</span
                                            >
                                        </label>
                                    </div>
                                    <h3 class="settings-group-title">
                                        Thresholds
                                    </h3>
                                    <div class="settings-row">
                                        <label class="slider-label">
                                            <span
                                                >Min Confidence Threshold:
                                                {{
                                                    promptSettings()!.minConfidenceThreshold.toFixed(
                                                        2
                                                    )
                                                }}</span
                                            >
                                            <input
                                                type="range"
                                                min="0"
                                                max="1"
                                                step="0.01"
                                                [(ngModel)]="
                                                    promptSettings()!
                                                        .minConfidenceThreshold
                                                "
                                                class="slider-input"
                                            />
                                        </label>
                                    </div>
                                    <div class="settings-row">
                                        <label class="slider-label">
                                            <span
                                                >Determinism Level:
                                                {{
                                                    promptSettings()!.determinismLevel.toFixed(
                                                        2
                                                    )
                                                }}</span
                                            >
                                            <input
                                                type="range"
                                                min="0"
                                                max="1"
                                                step="0.01"
                                                [(ngModel)]="
                                                    promptSettings()!
                                                        .determinismLevel
                                                "
                                                class="slider-input"
                                            />
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button
                        class="close-button-footer"
                        (click)="closePromptSettingsModal()"
                    >
                        Close
                    </button>
                    <button
                        class="save-button"
                        [disabled]="!hasPromptSettingsChanges()"
                        (click)="savePromptSettings()"
                    >
                        Save
                    </button>
                </div>
            </div>
        </div>
    }
</div>
